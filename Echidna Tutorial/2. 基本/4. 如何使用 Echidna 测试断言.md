## Introduction
åœ¨è¿™ä¸ªç®€çŸ­çš„æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Echidna æ£€æŸ¥æ™ºèƒ½åˆçº¦ä¸­çš„assertionsã€‚ å¯¹äºæ­¤ç¤ºä¾‹ï¼Œè¯·ç¡®ä¿æ‚¨ä½¿ç”¨ Solidity 0.7.x æˆ–æ›´æ—©ç‰ˆæœ¬ã€‚ å¦‚æœæ‚¨ä½¿ç”¨ Solidity 0.8.x è¿è¡Œå®ƒä»¬ï¼Œæµ‹è¯•å°†æ°¸è¿œä¸ä¼šå¤±è´¥ã€‚

## Write an assertion
å‡è®¾æˆ‘ä»¬æœ‰è¿™æ ·ä¸€ä»½åˆåŒï¼š
```
contract Incrementor {
  uint private counter = 2**200;

  function inc(uint val) public returns (uint){
    uint tmp = counter;
    counter += val;
    // tmp <= counter
    return (counter - tmp);
  }
}
```
æˆ‘ä»¬è¦ç¡®ä¿ tmp åœ¨è¿”å›å…¶å·®å€¼åå°äºæˆ–ç­‰äº counterã€‚ æˆ‘ä»¬å¯ä»¥ç¼–å†™ Echidna propertyï¼Œä½†æˆ‘ä»¬éœ€è¦å°† tmp å€¼å­˜å‚¨åœ¨æŸä¸ªåœ°æ–¹ã€‚ ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™æ ·çš„æ–­è¨€ï¼ˆ[example/assert.sol](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/example/assert.sol)ï¼‰ï¼š
```
contract Incrementor {
  uint private counter = 2**200;

  function inc(uint val) public returns (uint){
    uint tmp = counter;
    counter += val;
    assert (tmp <= counter);
    return (counter - tmp);
  }
}
```
æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨å¸¦æœ‰ä»»æ„æ•°é‡å‚æ•°çš„ç§°ä¸º `AssertionFailed` çš„ç‰¹æ®Šäº‹ä»¶æ¥è®© Echidna çŸ¥é“æ–­è¨€å¤±è´¥ï¼Œè€Œæ— éœ€ä½¿ç”¨`assert`ã€‚ è¿™é€‚ç”¨äºä»»ä½•åˆåŒã€‚ ä¾‹å¦‚ï¼š
```
contract Incrementor {
  event AssertionFailed(uint);
  uint private counter = 2**200;

  function inc(uint val) public returns (uint){
    uint tmp = counter;
    counter += val;
    if (tmp > counter)
      emit AssertionFailed(counter);
    return (counter - tmp);
  }
}
```
## Run Echidna
è¦åœ¨ Echidna ä¸­å¯ç”¨æ–­è¨€å¤±è´¥æµ‹è¯•ï¼Œæ‚¨å¯ä»¥ç›´æ¥ä»å‘½ä»¤è¡Œä½¿ç”¨ `--test-mode assertion`ã€‚

å¦åˆ™ï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ª [Echidna é…ç½®æ–‡ä»¶](https://github.com/crytic/echidna/wiki/Config) `config.yaml`ï¼Œå¹¶è®¾ç½® testMode ç”¨äºæ–­è¨€æ£€æŸ¥ï¼š
```
testMode: assertion
```
å½“æˆ‘ä»¬ä¸ Echidna è¿è¡Œè¿™ä¸ªåˆçº¦æ—¶ï¼Œæˆ‘ä»¬å¾—åˆ°äº†é¢„æœŸçš„ç»“æœï¼š
```
$ echidna-test assert.sol --test-mode assertion
Analyzing contract: assert.sol:Incrementor
assertion in inc: failed!ğŸ’¥  
  Call sequence, shrinking (2596/5000):
    inc(21711016731996786641919559689128982722488122124807605757398297001483711807488)
    inc(7237005577332262213973186563042994240829374041602535252466099000494570602496)
    inc(86844066927987146567678238756515930889952488499230423029593188005934847229952)

Seed: 1806480648350826486
```
å¦‚æ‚¨æ‰€è§ï¼ŒEchidna åœ¨ `inc` å‡½æ•°ä¸­æŠ¥å‘Šäº†ä¸€ä¸ªæ–­è¨€å¤±è´¥ã€‚ å¯ä»¥ä¸ºæ¯ä¸ªå‡½æ•°æ·»åŠ å¤šä¸ªæ–­è¨€ï¼Œä½†æ˜¯ï¼ŒEchidna æ— æ³•åˆ¤æ–­å“ªä¸ªæ–­è¨€å¤±è´¥ã€‚

## When and how to use assertions
å¦‚æœè¦æ£€æŸ¥çš„æ¡ä»¶ä¸æŸäº›æ“ä½œ `f` çš„æ­£ç¡®ä½¿ç”¨ç›´æ¥ç›¸å…³ï¼Œåˆ™æ–­è¨€å¯ä»¥ç”¨ä½œæ˜¾å¼å±æ€§çš„æ›¿ä»£æ–¹æ¡ˆã€‚ åœ¨æŸäº›ä»£ç ä¹‹åæ·»åŠ æ–­è¨€å°†å¼ºåˆ¶æ£€æŸ¥åœ¨æ‰§è¡Œåç«‹å³å‘ç”Ÿï¼š
```
function f(..) public {
    // some complex code
    ...
    assert (condition);
    ...
}
```
ç›¸åï¼Œä½¿ç”¨æ˜¾å¼å¸ƒå°”å±æ€§å°†éšæœºæ‰§è¡Œäº‹åŠ¡ï¼Œå¹¶ä¸”æ²¡æœ‰ç®€å•çš„æ–¹æ³•æ¥å‡†ç¡®æ‰§è¡Œä½•æ—¶æ£€æŸ¥ã€‚ ä»ç„¶å¯ä»¥æ‰§è¡Œæ­¤è§£å†³æ–¹æ³•ï¼š
```
function echidna_assert_after_f() public returns (bool) {
    f(..); 
    return(condition);
}
```
ä½†æ˜¯ï¼Œæœ‰ä¸€äº›é—®é¢˜ï¼š
- å¦‚æœ `f` å£°æ˜ä¸ºinternalæˆ–externalï¼Œåˆ™ä¸ä¼šç¼–è¯‘
- å°šä¸æ¸…æ¥šåº”è¯¥ä½¿ç”¨å“ªäº›å‚æ•°æ¥è°ƒç”¨ `f`
- å¦‚æœ `f` revertsï¼Œè¯¥å±æ€§å°†å¤±è´¥

Assertionså¯ä»¥å¸®åŠ©å…‹æœè¿™ä¸ªå¯èƒ½çš„é—®é¢˜ã€‚ ä¾‹å¦‚ï¼Œåœ¨è°ƒç”¨ internal or public å‡½æ•°æ—¶å¯ä»¥å¾ˆå®¹æ˜“åœ°æ£€æµ‹åˆ°å®ƒä»¬ï¼š
```
function f(..) public {
    // some complex code
    ...
    g(..) // this contains an assert
    ...
}
```
å¦‚æœ `g` æ˜¯externalçš„ï¼Œé‚£ä¹ˆæ–­è¨€å¤±è´¥åªèƒ½åœ¨ Solidity 0.8.x æˆ–æ›´é«˜ç‰ˆæœ¬ä¸­æ£€æµ‹åˆ°ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬å»ºè®®éµå¾ª [John Regehr](https://blog.regehr.org/archives/1091) å…³äºä½¿ç”¨æ–­è¨€çš„å»ºè®®ï¼š

- åœ¨æ–­è¨€æ£€æŸ¥æœŸé—´ä¸è¦å¼ºåˆ¶äº§ç”Ÿä»»ä½•å‰¯ä½œç”¨ã€‚ ä¾‹å¦‚ï¼šassert(ChangeStateAndReturn() == 1)
- ä¸è¦æ–­è¨€æ˜æ˜¾çš„é™ˆè¿°ã€‚ ä¾‹å¦‚ assert(var >= 0) å…¶ä¸­ var è¢«å£°æ˜ä¸º uintã€‚
  
æœ€åï¼Œè¯·ä¸è¦ä½¿ç”¨ require æ›¿æ¢ assertï¼Œå› ä¸º Echidna å°†æ— æ³•æ£€æµ‹åˆ°å®ƒï¼ˆä½†æ— è®ºå¦‚ä½•åˆåŒéƒ½ä¼šrevertï¼‰ã€‚

## Summary: Assertion Checking
ä¸‹é¢æ€»ç»“äº† Echidna åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­çš„è¿è¡Œæƒ…å†µï¼ˆè¯·è®°ä½ä½¿ç”¨ 0.7.x æˆ–æ›´æ—©ç‰ˆæœ¬ï¼‰ï¼š
```
contract Incrementor {
  uint private counter = 2**200;

  function inc(uint val) public returns (uint){
    uint tmp = counter;
    counter += val;
    assert (tmp <= counter);
    return (counter - tmp);
  }
}
```

```
$ echidna-test assert.sol --test-mode assertion
Analyzing contract: assert.sol:Incrementor
assertion in inc: failed!ğŸ’¥  
  Call sequence, shrinking (2596/5000):
    inc(21711016731996786641919559689128982722488122124807605757398297001483711807488)
    inc(7237005577332262213973186563042994240829374041602535252466099000494570602496)
    inc(86844066927987146567678238756515930889952488499230423029593188005934847229952)

Seed: 1806480648350826486
```
Echidna å‘ç°ï¼Œå¦‚æœä½¿ç”¨å¤§å‚æ•°å¤šæ¬¡è°ƒç”¨æ­¤å‡½æ•°ï¼Œåˆ™ `inc` ä¸­çš„æ–­è¨€å¯èƒ½ä¼šå¤±è´¥ã€‚