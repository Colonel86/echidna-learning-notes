# 在模糊活动期间调用过滤函数

## Introduction
我们将看到如何过滤要模糊的函数。 目标是以下智能合约（[example/multi.sol](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/example/multi.sol)）：
```
contract C {
  bool state1 = false;
  bool state2 = false;
  bool state3 = false;
  bool state4 = false;

  function f(uint x) public {
    require(x == 12);
    state1 = true;
  }

  function g(uint x) public {
    require(state1);
    require(x == 8);
    state2 = true;
  }

  function h(uint x) public {
    require(state2);
    require(x == 42);
    state3 = true;
  }

 function i() public {
    require(state3);
    state4 = true;
  }

  function reset1() public {
    state1 = false;
    state2 = false;
    state3 = false;
    return;
  }

  function reset2() public {
    state1 = false;
    state2 = false;
    state3 = false;
    return;
  }

  function echidna_state4() public returns (bool) {
    return (!state4);
  }

}
```

这个小例子迫使 Echidna 找到一定的交易序列来改变状态变量。 这对于 fuzzer 来说很难（推荐使用像 [Manticore](https://github.com/trailofbits/manticore) 这样的符号执行工具）。 我们可以运行 Echidna 来验证这一点：
```
$ echidna-test multi.sol 
...
echidna_state4: passed! 🎉
Seed: -3684648582249875403
```

## Filtering functions
Echidna 很难找到正确的序列来测试这个合约，因为两个重置函数（`reset1` 和 `reset2`）会将所有状态变量设置为 `false`。 但是，我们可以使用特殊的 Echidna 功能将重置函数列入黑名单或仅将 `f`、`g`、`h` 和 `i` 函数列入白名单。

要将函数列入黑名单，我们可以使用此配置文件：
```
filterBlacklist: true
filterFunctions: ["C.reset1()", "C.reset2()"]
```
过滤函数的另一种方法是列出白名单的函数。 为此，我们可以使用这个配置文件：
```
filterBlacklist: false
filterFunctions: ["C.f(uint256)", "C.g(uint256)", "C.h(uint256)", "C.i()"]
```
- filterBlacklist 默认为 true。
- 过滤将通过完整的函数名（contract name+“.”+ABI function signature）进行。 如果您有 `f()` 和 `f(uint256)`，则可以准确指定要过滤的函数。

## Run Echidna
使用配置文件 blacklist.yaml 运行 Echidna：
```
$ echidna-test multi.sol --config blacklist.yaml 
...
echidna_state4: failed!💥  
  Call sequence:
    f(12)
    g(8)
    h(42)
    i()
```
Echidna 几乎会立即找到伪造财产的交易序列。

## Summary: Filtering functions
Echidna 可以使用以下命令在fuzzing活动期间将要调用的函数列入黑名单或白名单：
```
filterBlacklist: true
filterFunctions: ["C.f1()", "C.f2()", "C.f3()"]
```
```
$ echidna-test contract.sol --config config.yaml 
...
```
根据 `filterBlacklist` 布尔值，Echidna 将通过将 `C.f1()`、`C.f2()` 和 `C.f3()` 列入黑名单或仅调用这些函数来启动fuzzing活动。