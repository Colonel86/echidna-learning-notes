# åœ¨æ¨¡ç³Šæ´»åŠ¨æœŸé—´è°ƒç”¨è¿‡æ»¤å‡½æ•°

## Introduction
æˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•è¿‡æ»¤è¦æ¨¡ç³Šçš„å‡½æ•°ã€‚ ç›®æ ‡æ˜¯ä»¥ä¸‹æ™ºèƒ½åˆçº¦ï¼ˆ[example/multi.sol](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/example/multi.sol)ï¼‰ï¼š
```
contract C {
  bool state1 = false;
  bool state2 = false;
  bool state3 = false;
  bool state4 = false;

  function f(uint x) public {
    require(x == 12);
    state1 = true;
  }

  function g(uint x) public {
    require(state1);
    require(x == 8);
    state2 = true;
  }

  function h(uint x) public {
    require(state2);
    require(x == 42);
    state3 = true;
  }

 function i() public {
    require(state3);
    state4 = true;
  }

  function reset1() public {
    state1 = false;
    state2 = false;
    state3 = false;
    return;
  }

  function reset2() public {
    state1 = false;
    state2 = false;
    state3 = false;
    return;
  }

  function echidna_state4() public returns (bool) {
    return (!state4);
  }

}
```

è¿™ä¸ªå°ä¾‹å­è¿«ä½¿ Echidna æ‰¾åˆ°ä¸€å®šçš„äº¤æ˜“åºåˆ—æ¥æ”¹å˜çŠ¶æ€å˜é‡ã€‚ è¿™å¯¹äº fuzzer æ¥è¯´å¾ˆéš¾ï¼ˆæ¨èä½¿ç”¨åƒ [Manticore](https://github.com/trailofbits/manticore) è¿™æ ·çš„ç¬¦å·æ‰§è¡Œå·¥å…·ï¼‰ã€‚ æˆ‘ä»¬å¯ä»¥è¿è¡Œ Echidna æ¥éªŒè¯è¿™ä¸€ç‚¹ï¼š
```
$ echidna-test multi.sol 
...
echidna_state4: passed! ğŸ‰
Seed: -3684648582249875403
```

## Filtering functions
Echidna å¾ˆéš¾æ‰¾åˆ°æ­£ç¡®çš„åºåˆ—æ¥æµ‹è¯•è¿™ä¸ªåˆçº¦ï¼Œå› ä¸ºä¸¤ä¸ªé‡ç½®å‡½æ•°ï¼ˆ`reset1` å’Œ `reset2`ï¼‰ä¼šå°†æ‰€æœ‰çŠ¶æ€å˜é‡è®¾ç½®ä¸º `false`ã€‚ ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç‰¹æ®Šçš„ Echidna åŠŸèƒ½å°†é‡ç½®å‡½æ•°åˆ—å…¥é»‘åå•æˆ–ä»…å°† `f`ã€`g`ã€`h` å’Œ `i` å‡½æ•°åˆ—å…¥ç™½åå•ã€‚

è¦å°†å‡½æ•°åˆ—å…¥é»‘åå•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ­¤é…ç½®æ–‡ä»¶ï¼š
```
filterBlacklist: true
filterFunctions: ["C.reset1()", "C.reset2()"]
```
è¿‡æ»¤å‡½æ•°çš„å¦ä¸€ç§æ–¹æ³•æ˜¯åˆ—å‡ºç™½åå•çš„å‡½æ•°ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼š
```
filterBlacklist: false
filterFunctions: ["C.f(uint256)", "C.g(uint256)", "C.h(uint256)", "C.i()"]
```
- filterBlacklist é»˜è®¤ä¸º trueã€‚
- è¿‡æ»¤å°†é€šè¿‡å®Œæ•´çš„å‡½æ•°åï¼ˆcontract name+â€œ.â€+ABI function signatureï¼‰è¿›è¡Œã€‚ å¦‚æœæ‚¨æœ‰ `f()` å’Œ `f(uint256)`ï¼Œåˆ™å¯ä»¥å‡†ç¡®æŒ‡å®šè¦è¿‡æ»¤çš„å‡½æ•°ã€‚

## Run Echidna
ä½¿ç”¨é…ç½®æ–‡ä»¶ blacklist.yaml è¿è¡Œ Echidnaï¼š
```
$ echidna-test multi.sol --config blacklist.yaml 
...
echidna_state4: failed!ğŸ’¥  
  Call sequence:
    f(12)
    g(8)
    h(42)
    i()
```
Echidna å‡ ä¹ä¼šç«‹å³æ‰¾åˆ°ä¼ªé€ è´¢äº§çš„äº¤æ˜“åºåˆ—ã€‚

## Summary: Filtering functions
Echidna å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨fuzzingæ´»åŠ¨æœŸé—´å°†è¦è°ƒç”¨çš„å‡½æ•°åˆ—å…¥é»‘åå•æˆ–ç™½åå•ï¼š
```
filterBlacklist: true
filterFunctions: ["C.f1()", "C.f2()", "C.f3()"]
```
```
$ echidna-test contract.sol --config config.yaml 
...
```
æ ¹æ® `filterBlacklist` å¸ƒå°”å€¼ï¼ŒEchidna å°†é€šè¿‡å°† `C.f1()`ã€`C.f2()` å’Œ `C.f3()` åˆ—å…¥é»‘åå•æˆ–ä»…è°ƒç”¨è¿™äº›å‡½æ•°æ¥å¯åŠ¨fuzzingæ´»åŠ¨ã€‚