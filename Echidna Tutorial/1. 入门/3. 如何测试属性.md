# 使用 Echidna 测试属性
## 介绍
我们将看到如何使用 Echidna 测试smart contract。 目标是以下smart contract（[example/token.sol](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/example/token.sol)）：
```
contract Token {
    mapping(address => uint) public balances;
    // 空头给caller 1000个token
    function airdrop() public {
        balances[msg.sender] = 1000;
    }
    // 每调用一次消耗caller一个token
    function consume() public {
        require(balances[msg.sender]>0);
        balances[msg.sender] -= 1;
    }
    // 后门方法：为Echidna模糊测试准备
    function backdoor() public {
        balances[msg.sender] += 1;
    }
}
```

我们将假设此令牌具有以下属性：
- 任何人最多可以拥有 1000 个代币
- 代币无法转移（不是 ERC20 代币）

## 写一个属性
Echidna 属性是 Solidity 函数。 属性必须：
- 没有争论
- 如果成功则返回true
- 它的名字以`echidna`开头

Echidna将：
- 自动生成任意交易来测试属性。
- 报告任何导致属性返回 false 或引发错误的事务。
- 调用属性时丢弃副作用（即，如果属性更改状态变量，则在测试后丢弃）

以下属性检查调用者是否可以拥有不超过 1000 个令牌：
```
function echidna_balance_under_1000() public view returns(bool){
    return balances[msg.sender] <= 1000;
}
```
使用继承将您的合同与您的属性分开：
```
contract TestToken is Token{
    function echidna_balance_under_1000() public view returns(bool){
        return balances[msg.sender] <= 1000;
    }
}
```
[example/testtoken.sol](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/example/testtoken.sol)实现该属性并从令牌继承。

## 启动合同
Echidna 需要一个没有输入参数的构造函数。 如果您的合约需要特定的初始化，则需要在构造函数中进行。

Echidna中有一些具体的地址：
- 0x30000 调用构造函数。
- 0x10000、0x20000 和 0x30000 随机调用其他函数。
  
在当前示例中，我们不需要任何特定的初始化。因此，我们的构造函数是空的。

Echidna通过下面命令启动:
```
echidna-test contract.sol
```
如果 contract.sol 包含多个合约，您可以指定目标：
```
echidna-test contract.sol --contract MyContract
```
## 总结：测试属性
下面总结了 Echidna 在我们的示例中的运行情况：
```
contract TestToken is Token{
    constructor() public {}
    function echidna_balance_under_1000() public view returns(bool){
        return balances[msg.sender] <= 1000;
    }
}
```

```
$ echidna-test testtoken.sol --contract TestToken
...

echidna_balance_under_1000: failed!💥  
  Call sequence, shrinking (1205/5000):
    airdrop()
    backdoor()

...
```
Echidna可以正确的发现如果调用`backdoor()`就侵犯了财产。