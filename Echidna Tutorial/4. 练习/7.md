## Setup
1. æŒ‰ç…§ Damn Vulnerable DeFi CTF é¡µé¢ä¸Šçš„è¯´æ˜è¿›è¡Œæ“ä½œï¼Œå³ï¼š
   - é€šè¿‡ git clone https://github.com/tinchoabbate/damn-vulnerable-defi -b v2.0.0 å…‹éš† repoï¼Œå’Œ
   - é€šè¿‡ yarn install å®‰è£…ä¾èµ–é¡¹ã€‚

2. è¦åœ¨è¿™äº›åˆçº¦ä¸Šè¿è¡Œ Echidnaï¼Œæ‚¨å¿…é¡»æ³¨é‡Šæ‰ hardhat.config.js ä¸­çš„dependencyCompiler éƒ¨åˆ†ã€‚ å¦åˆ™ï¼Œé¡¹ç›®å°†æ— æ³•ä½¿ç”¨ crytic-compile è¿›è¡Œç¼–è¯‘ã€‚ è¯·å‚é˜…æ­¤å¤„æä¾›çš„ç¤ºä¾‹ã€‚
3. åœ¨æœ¬ç»ƒä¹ ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Etheno éƒ¨ç½² SideEntranceLenderPool åˆçº¦ã€‚ ä½ å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/end-to-end-testing.md)æ‰¾åˆ°æ›´å¤šå…³äº Etheno çš„ä¿¡æ¯ã€‚
4. åˆ†æ `test/side-entrance/side-entrance.challenge.js` ä¸­çš„ `before` å‡½æ•°ï¼Œä»¥ç¡®å®šéœ€è¦è¿›è¡Œå“ªäº›åˆå§‹è®¾ç½®ã€‚
5. åˆ›å»ºä¸€ä¸ªåä¸º `E2E` çš„åˆçº¦ï¼Œç”¨äº Echidna çš„ç«¯åˆ°ç«¯æµ‹è¯•ã€‚

## Goals
- ä½¿ç”¨æ­£ç¡®çš„åˆçº¦å’Œå¿…è¦çš„ä½™é¢è®¾ç½®æµ‹è¯•ç¯å¢ƒã€‚
- æ·»åŠ ä¸€ä¸ªå±æ€§æ¥æ£€æŸ¥ SideEntranceLenderPool åˆçº¦çš„ä½™é¢æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ã€‚
- ä½¿ç”¨å¿…è¦çš„é…ç½®é€‰é¡¹åˆ›å»ºä¸€ä¸ª config.yamlã€‚
- ä¸€æ—¦ Echidna å‘ç°é”™è¯¯ï¼Œè§£å†³é—®é¢˜ï¼Œç„¶åç”¨ Echidna é‡æ–°å°è¯•æ‚¨çš„è´¢äº§ã€‚

## Solution
æ­¤è§£å†³æ–¹æ¡ˆå¯åœ¨[exercises/exercise7/solution.sol](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/exercises/exercise7/solution.sol) ä¸­æ‰¾åˆ°

#### è§£å†³æ–¹æ¡ˆè§£é‡Šï¼ˆå‰é¢æœ‰å‰§é€ï¼‰
ä¾§é—¨æŒ‘æˆ˜çš„ç›®æ ‡æ˜¯æ„è¯†åˆ°åˆçº¦å¯¹å…¶ ETH ä½™é¢çš„è®°å¸é…ç½®é”™è¯¯ã€‚ balanceBeforeç”¨äºè·Ÿè¸ªé—ªè´·ä¹‹å‰çš„åˆçº¦ä½™é¢BUT`address(this).balance`ç”¨äºè·Ÿè¸ªflash loanä¹‹åçš„åˆçº¦ä½™é¢ã€‚ å› æ­¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å­˜æ¬¾åŠŸèƒ½æ¥å¿è¿˜æ‚¨çš„flash loanï¼ŒåŒæ—¶ä»ç„¶ä¿æŒåˆçº¦çš„ ETH æ€»ä½™é¢æ²¡æœ‰æ”¹å˜ï¼ˆå³ `address(this).balance >= balanceBefore`ï¼‰ã€‚ ç”±äºå­˜å…¥çš„ ETH ç°åœ¨å½’æ‚¨æ‰€æœ‰ï¼Œæ‚¨ç°åœ¨ä¹Ÿå¯ä»¥æå–å®ƒå¹¶ä»åˆçº¦ä¸­è€—å°½æ‰€æœ‰èµ„é‡‘ã€‚

æˆ‘ä»¬æŒ‡ç¤ºEchidnaè¿›è¡Œå¿«é€Ÿè´·æ¬¾ã€‚ ä½¿ç”¨ `setEnableWithdraw` å’Œ `setEnableDeposit` Echidna å°†åœ¨ flashloan å›è°ƒä¸­æœç´¢è¦è°ƒç”¨çš„å‡½æ•°ï¼Œä»¥å°è¯•ç ´å `testPoolBalance` å±æ€§ã€‚

åœ¨æŸäº›æ—¶å€™ï¼ŒEchidna ä¼šå‘ç°ï¼Œå¦‚æœ (1) `deposit`ç”¨äºå¿è¿˜ flash loanï¼Œå¹¶ä¸” (2) ä¹‹åç«‹å³è°ƒç”¨`withdraw`ï¼Œåˆ™ `testPoolBalance` å±æ€§ä¼šä¸­æ–­ã€‚

è¦ä½¿ç”¨ Ethenoï¼Œæ‚¨å¯ä»¥é€šè¿‡ Hardhat ä½¿ç”¨å¦‚ä¸‹ç¤ºä¾‹éƒ¨ç½²è„šæœ¬ï¼š
```
const hre = require("hardhat");
const ethers = hre.ethers;

async function main() {
  const ETHER_IN_POOL = ethers.utils.parseEther("1000");

  [deployer, attacker] = await ethers.getSigners();

  const SideEntranceLenderPoolFactory = await ethers.getContractFactory(
    "SideEntranceLenderPool",
    deployer
  );

  pool = await SideEntranceLenderPoolFactory.deploy();
  await pool.deployed();
  console.log(`pool address ${pool.address}`);

  await this.pool.deposit({ value: ETHER_IN_POOL });

}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
```

ç¡®ä¿æ·»åŠ  localhost ç½‘ç»œä»¥ä¾¿èƒ½å¤Ÿéƒ¨ç½²åˆ° Ethenoã€‚ å®‰å…¨å¸½ç¤ºä¾‹ï¼š
```
networks: {
  localhost: {
    url: "http://127.0.0.1:8545",
  },
}
```

è¦éƒ¨ç½²åˆ° Ethenoï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
```
etheno --ganache --ganache-args="--miner.blockGasLimit 10000000" -x init.json
```
åœ¨å¦ä¸€ä¸ª shell ä¸­è¿è¡Œä»¥ä¸‹å®‰å…¨å¸½å‘½ä»¤ï¼š
```
npx hardhat run scripts/deploy.js --network localhost
```
ç„¶åä½ çš„ shell å‘½ä»¤å°±å¯ä»¥æ­£å¸¸å·¥ä½œäº†ã€‚

ä¸è¦å¿˜è®°å°†åˆå§‹åŒ– JSON æ–‡ä»¶ (init.json) ä» Etheno å¤åˆ¶åˆ°æ‚¨çš„æ¨¡ç³Šæµ‹è¯•ç¯å¢ƒï¼

Echidnaè¾“å‡ºç¤ºä¾‹ï¼š
```
$ echidna-test . --contract E2E --config config.yaml
...
testPoolBalance(): failed!ğŸ’¥
  Call sequence, shrinking (3003/5000):
    setEnableDeposit(true,208)
    flashLoan(1)
    withdraw()
    testPoolBalance()
...
```