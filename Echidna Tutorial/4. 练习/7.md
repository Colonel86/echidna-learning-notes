## Setup
1. 按照 Damn Vulnerable DeFi CTF 页面上的说明进行操作，即：
   - 通过 git clone https://github.com/tinchoabbate/damn-vulnerable-defi -b v2.0.0 克隆 repo，和
   - 通过 yarn install 安装依赖项。

2. 要在这些合约上运行 Echidna，您必须注释掉 hardhat.config.js 中的dependencyCompiler 部分。 否则，项目将无法使用 crytic-compile 进行编译。 请参阅此处提供的示例。
3. 在本练习中，我们将使用 Etheno 部署 SideEntranceLenderPool 合约。 你可以在[这里](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/end-to-end-testing.md)找到更多关于 Etheno 的信息。
4. 分析 `test/side-entrance/side-entrance.challenge.js` 中的 `before` 函数，以确定需要进行哪些初始设置。
5. 创建一个名为 `E2E` 的合约，用于 Echidna 的端到端测试。

## Goals
- 使用正确的合约和必要的余额设置测试环境。
- 添加一个属性来检查 SideEntranceLenderPool 合约的余额是否发生了变化。
- 使用必要的配置选项创建一个 config.yaml。
- 一旦 Echidna 发现错误，解决问题，然后用 Echidna 重新尝试您的财产。

## Solution
此解决方案可在[exercises/exercise7/solution.sol](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/exercises/exercise7/solution.sol) 中找到

#### 解决方案解释（前面有剧透）
侧门挑战的目标是意识到合约对其 ETH 余额的记帐配置错误。 balanceBefore用于跟踪闪贷之前的合约余额BUT`address(this).balance`用于跟踪flash loan之后的合约余额。 因此，您可以使用存款功能来偿还您的flash loan，同时仍然保持合约的 ETH 总余额没有改变（即 `address(this).balance >= balanceBefore`）。 由于存入的 ETH 现在归您所有，您现在也可以提取它并从合约中耗尽所有资金。

我们指示Echidna进行快速贷款。 使用 `setEnableWithdraw` 和 `setEnableDeposit` Echidna 将在 flashloan 回调中搜索要调用的函数，以尝试破坏 `testPoolBalance` 属性。

在某些时候，Echidna 会发现，如果 (1) `deposit`用于偿还 flash loan，并且 (2) 之后立即调用`withdraw`，则 `testPoolBalance` 属性会中断。

要使用 Etheno，您可以通过 Hardhat 使用如下示例部署脚本：
```
const hre = require("hardhat");
const ethers = hre.ethers;

async function main() {
  const ETHER_IN_POOL = ethers.utils.parseEther("1000");

  [deployer, attacker] = await ethers.getSigners();

  const SideEntranceLenderPoolFactory = await ethers.getContractFactory(
    "SideEntranceLenderPool",
    deployer
  );

  pool = await SideEntranceLenderPoolFactory.deploy();
  await pool.deployed();
  console.log(`pool address ${pool.address}`);

  await this.pool.deposit({ value: ETHER_IN_POOL });

}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
```

确保添加 localhost 网络以便能够部署到 Etheno。 安全帽示例：
```
networks: {
  localhost: {
    url: "http://127.0.0.1:8545",
  },
}
```

要部署到 Etheno，请运行以下命令：
```
etheno --ganache --ganache-args="--miner.blockGasLimit 10000000" -x init.json
```
在另一个 shell 中运行以下安全帽命令：
```
npx hardhat run scripts/deploy.js --network localhost
```
然后你的 shell 命令就可以正常工作了。

不要忘记将初始化 JSON 文件 (init.json) 从 Etheno 复制到您的模糊测试环境！

Echidna输出示例：
```
$ echidna-test . --contract E2E --config config.yaml
...
testPoolBalance(): failed!💥
  Call sequence, shrinking (3003/5000):
    setEnableDeposit(true,208)
    flashLoan(1)
    withdraw()
    testPoolBalance()
...
```