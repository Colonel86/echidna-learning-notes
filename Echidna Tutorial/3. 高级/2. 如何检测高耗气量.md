## 介绍
我们将看到如何使用 Echidna 找到高耗gas的交易。 目标是以下智能合约（[example/gas.sol](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/example/gas.sol)）：
```
contract C {
  uint state;

  function expensive(uint8 times) internal {
    for(uint8 i=0; i < times; i++)
      state = state + i;
  }

  function f(uint x, uint y, uint8 times) public {
    if (x == 42 && y == 123)
      expensive(times);
    else
      state = 0;
  }

  function echidna_test() public returns (bool) {
    return true;
  }

}
```
这里`expensive`可能会有很大的gas消耗。

目前，Echidna 总是需要一个property来测试：这里 `echidna_test` 总是返回 `true。` 我们可以运行 Echidna 来验证这一点：
```
$ echidna-test gas.sol
...
echidna_test: passed! 🎉

Seed: 2320549945714142710
```
## 测量气体消耗
要启用 Echidna 的消耗gas功能，请创建配置文件 [config.yaml](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/example/gas.yaml)：
```
estimateGas: true
```
在本例中，我们还将减小事务序列的大小以使结果更易于理解：
```
seqLen: 2
estimateGas: true
```
## Run Echidna
一旦我们创建了配置文件，我们就可以像这样运行 Echidna：
```
$ echidna-test gas.sol --config config.yaml 
...
echidna_test: passed! 🎉

f used a maximum of 1333608 gas
  Call sequence:
    f(42,123,249) Gas price: 0x10d5733f0a Time delay: 0x495e5 Block delay: 0x88b2

Unique instructions: 157
Unique codehashes: 1
Seed: -325611019680165325
```
显示的气体是 [HEVM](https://github.com/dapphub/dapptools/tree/master/src/hevm#hevm-) 提供的估计值。

## Filtering Out Gas-Reducing Calls(过滤掉气体减少呼叫)
关于在[模糊测试期间调用的过滤函数](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/filtering-functions.md)的教程展示了如何在测试期间删除一些函数。

这对于获得准确的气体估计至关重要。 考虑以下示例（[example/pushpop.sol](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/example/pushpop.sol)）：

```
contract C {
  address [] addrs;
  function push(address a) public {
    addrs.push(a);
  }
  function pop() public {
    addrs.pop();
  }
  function clear() public{
    addrs.length = 0;
  }
  function check() public{
    for(uint256 i = 0; i < addrs.length; i++)
      for(uint256 j = i+1; j < addrs.length; j++)
        if (addrs[i] == addrs[j])
          addrs[j] = address(0x0);
  }
  function echidna_test() public returns (bool) {
      return true;
  }
}
```
如果 Echidna 使用这个 config.yaml，它可以调用所有函数，并且不会轻易找到高 gas 成本的交易：
```
$ echidna-test pushpop.sol --config config.yaml
...
pop used a maximum of 10746 gas
...
check used a maximum of 23730 gas
...
clear used a maximum of 35916 gas
...
push used a maximum of 40839 gas
```
这是因为成本取决于 [addrs] 的大小，而随机调用往往会使数组几乎为空。 然而，将 `pop` 和 `clear` 列入黑名单会给我们带来更好的结果（[example/blacklistpushpop.yaml](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/example/blacklistpushpop.yaml)）：

```
estimateGas: true
filterBlacklist: true
filterFunctions: ["C.pop()", "C.clear()"]
```
```
$ echidna-test pushpop.sol --config config.yaml
...
push used a maximum of 40839 gas
...
check used a maximum of 1484472 gas
```

## 总结：寻找高gas消耗的交易
Echidna 可以使用estimateGas 配置选项找到具有高gas 消耗的交易：
```
estimateGas: true
```

```
$ echidna-test contract.sol --config config.yaml 
```
fuzzing活动结束后，Echidna 将报告每个函数的最大消耗gas序列。
