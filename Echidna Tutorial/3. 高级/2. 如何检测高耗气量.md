## ä»‹ç»
æˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•ä½¿ç”¨ Echidna æ‰¾åˆ°é«˜è€—gasçš„äº¤æ˜“ã€‚ ç›®æ ‡æ˜¯ä»¥ä¸‹æ™ºèƒ½åˆçº¦ï¼ˆ[example/gas.sol](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/example/gas.sol)ï¼‰ï¼š
```
contract C {
  uint state;

  function expensive(uint8 times) internal {
    for(uint8 i=0; i < times; i++)
      state = state + i;
  }

  function f(uint x, uint y, uint8 times) public {
    if (x == 42 && y == 123)
      expensive(times);
    else
      state = 0;
  }

  function echidna_test() public returns (bool) {
    return true;
  }

}
```
è¿™é‡Œ`expensive`å¯èƒ½ä¼šæœ‰å¾ˆå¤§çš„gasæ¶ˆè€—ã€‚

ç›®å‰ï¼ŒEchidna æ€»æ˜¯éœ€è¦ä¸€ä¸ªpropertyæ¥æµ‹è¯•ï¼šè¿™é‡Œ `echidna_test` æ€»æ˜¯è¿”å› `trueã€‚` æˆ‘ä»¬å¯ä»¥è¿è¡Œ Echidna æ¥éªŒè¯è¿™ä¸€ç‚¹ï¼š
```
$ echidna-test gas.sol
...
echidna_test: passed! ğŸ‰

Seed: 2320549945714142710
```
## æµ‹é‡æ°”ä½“æ¶ˆè€—
è¦å¯ç”¨ Echidna çš„æ¶ˆè€—gasåŠŸèƒ½ï¼Œè¯·åˆ›å»ºé…ç½®æ–‡ä»¶ [config.yaml](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/example/gas.yaml)ï¼š
```
estimateGas: true
```
åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬è¿˜å°†å‡å°äº‹åŠ¡åºåˆ—çš„å¤§å°ä»¥ä½¿ç»“æœæ›´æ˜“äºç†è§£ï¼š
```
seqLen: 2
estimateGas: true
```
## Run Echidna
ä¸€æ—¦æˆ‘ä»¬åˆ›å»ºäº†é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥åƒè¿™æ ·è¿è¡Œ Echidnaï¼š
```
$ echidna-test gas.sol --config config.yaml 
...
echidna_test: passed! ğŸ‰

f used a maximum of 1333608 gas
  Call sequence:
    f(42,123,249) Gas price: 0x10d5733f0a Time delay: 0x495e5 Block delay: 0x88b2

Unique instructions: 157
Unique codehashes: 1
Seed: -325611019680165325
```
æ˜¾ç¤ºçš„æ°”ä½“æ˜¯ [HEVM](https://github.com/dapphub/dapptools/tree/master/src/hevm#hevm-) æä¾›çš„ä¼°è®¡å€¼ã€‚

## Filtering Out Gas-Reducing Calls(è¿‡æ»¤æ‰æ°”ä½“å‡å°‘å‘¼å«)
å…³äºåœ¨[æ¨¡ç³Šæµ‹è¯•æœŸé—´è°ƒç”¨çš„è¿‡æ»¤å‡½æ•°](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/filtering-functions.md)çš„æ•™ç¨‹å±•ç¤ºäº†å¦‚ä½•åœ¨æµ‹è¯•æœŸé—´åˆ é™¤ä¸€äº›å‡½æ•°ã€‚

è¿™å¯¹äºè·å¾—å‡†ç¡®çš„æ°”ä½“ä¼°è®¡è‡³å…³é‡è¦ã€‚ è€ƒè™‘ä»¥ä¸‹ç¤ºä¾‹ï¼ˆ[example/pushpop.sol](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/example/pushpop.sol)ï¼‰ï¼š

```
contract C {
  address [] addrs;
  function push(address a) public {
    addrs.push(a);
  }
  function pop() public {
    addrs.pop();
  }
  function clear() public{
    addrs.length = 0;
  }
  function check() public{
    for(uint256 i = 0; i < addrs.length; i++)
      for(uint256 j = i+1; j < addrs.length; j++)
        if (addrs[i] == addrs[j])
          addrs[j] = address(0x0);
  }
  function echidna_test() public returns (bool) {
      return true;
  }
}
```
å¦‚æœ Echidna ä½¿ç”¨è¿™ä¸ª config.yamlï¼Œå®ƒå¯ä»¥è°ƒç”¨æ‰€æœ‰å‡½æ•°ï¼Œå¹¶ä¸”ä¸ä¼šè½»æ˜“æ‰¾åˆ°é«˜ gas æˆæœ¬çš„äº¤æ˜“ï¼š
```
$ echidna-test pushpop.sol --config config.yaml
...
pop used a maximum of 10746 gas
...
check used a maximum of 23730 gas
...
clear used a maximum of 35916 gas
...
push used a maximum of 40839 gas
```
è¿™æ˜¯å› ä¸ºæˆæœ¬å–å†³äº [addrs] çš„å¤§å°ï¼Œè€Œéšæœºè°ƒç”¨å¾€å¾€ä¼šä½¿æ•°ç»„å‡ ä¹ä¸ºç©ºã€‚ ç„¶è€Œï¼Œå°† `pop` å’Œ `clear` åˆ—å…¥é»‘åå•ä¼šç»™æˆ‘ä»¬å¸¦æ¥æ›´å¥½çš„ç»“æœï¼ˆ[example/blacklistpushpop.yaml](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/example/blacklistpushpop.yaml)ï¼‰ï¼š

```
estimateGas: true
filterBlacklist: true
filterFunctions: ["C.pop()", "C.clear()"]
```
```
$ echidna-test pushpop.sol --config config.yaml
...
push used a maximum of 40839 gas
...
check used a maximum of 1484472 gas
```

## æ€»ç»“ï¼šå¯»æ‰¾é«˜gasæ¶ˆè€—çš„äº¤æ˜“
Echidna å¯ä»¥ä½¿ç”¨estimateGas é…ç½®é€‰é¡¹æ‰¾åˆ°å…·æœ‰é«˜gas æ¶ˆè€—çš„äº¤æ˜“ï¼š
```
estimateGas: true
```

```
$ echidna-test contract.sol --config config.yaml 
```
fuzzingæ´»åŠ¨ç»“æŸåï¼ŒEchidna å°†æŠ¥å‘Šæ¯ä¸ªå‡½æ•°çš„æœ€å¤§æ¶ˆè€—gasåºåˆ—ã€‚
