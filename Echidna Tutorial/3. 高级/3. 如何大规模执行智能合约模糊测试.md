# 使用 Echidna 大规模进行智能合约 Fuzzing
在本教程中，我们将回顾如何使用 Echidna 创建用于fuzzing合约的专用服务器。

#### 工作流程：
- 安装和设置专用服务器
- 开始一个简短的fuzzing活动
- 开始一个连续的fuzzing活动
- 添加properties、检查覆盖率并在必要时修改代码
- 结束活动

## 1. Install and setup a dedicated server(安装和设置专用服务器)
首先，获取至少具有 32 GB RAM 和尽可能多内核的专用服务器。 首先为 fuzzing 活动创建一个用户。 仅使用 root 帐户创建非特权用户：
```
# adduser echidna
# usermod -aG sudo echidna
```
然后，使用该用户（`echidna`）安装一些基本依赖项：
```
$ sudo apt install unzip python3-pip
```
然后安装构建您的智能合约以及`slither`和`echidna-parade`所需的一切。 例如：
```
$ pip3 install solc-select
$ solc-select install all
$ pip3 install slither_analyzer
$ pip3 install echidna_parade
```
在 /home/echidna/.bashrc 末尾添加 $PATH=$PATH:/home/echidna/.local/bin

接下来，安装 Echidna。 最简单的方法是下载最新的预编译 Echidna 版本，解压缩，然后将其移动到 /home/echidna/.local/bin：
```
$ wget "https://github.com/crytic/echidna/releases/download/v2.0.0/echidna-test-2.0.0-Ubuntu-18.04.tar.gz"
$ tar -xf echidna-test-2.0.0-Ubuntu-18.04.tar.gz
$ mv echidna-test /home/echidna/.local/bin
```
## 2. Start a short fuzzing campaign(开始一个简短的模糊测试活动)
选择要测试的合约并在需要时提供初始化。 它不必是完美的，只需从一些基本的东西开始并迭代结果即可。 在开始此活动之前，请修改您的 echidna 配置以定义要使用的corpus目录。 例如：
```
corpusDir: "corpus-exploration"
```
该目录将自动创建，但由于我们正在开始一个新的活动，如果它是由以前的echidna活动创建的，请删除语料库目录。 如果您没有任何要测试的属性，则可以使用：
```
testMode: exploration
```
允许 Echidna 在没有任何properties的情况下运行。

我们将开始一个非常短的 Echidna 运行（5 分钟），以检查一切是否正常。 为此，请使用以下配置：
```
testLimit: 100000000000
timeout: 300 # 5 minutes
```

运行后，检查位于 `corpus-exploration/covered.*.txt` 中的覆盖率文件。 如果初始化错误，请清理 corpus-exploration 目录并重新启动活动。

## 3. Starting a continuous fuzzing campaign(开始一个连续的模糊测试活动)
当您对初始化的第一次迭代感到满意时，我们可以开始使用 [echidna-parade](https://github.com/agroce/echidna-parade) 进行探索和测试的“持续活动”。 在开始之前，请仔细检查您的配置文件。 例如，如果您添加了properties，请不要忘记删除 benchmarkMode。

我们将用一个例子来展示它，其中：

- 初始语料库为空
- 基本配置文件将是 exploration.yaml
- 运行初始实例的时间为 3600 秒（1 小时）
- 运行每一“代”的时间为 1800 秒（30 分钟）
- 活动将以连续模式运行（如果超时为-1，则意味着永远运行）
- 每代 Echidna 实例的数量为 8。这应该根据可用内核的数量进行调整，但如果您不想杀死服务器，请避免使用所有内核
- 目标合约名为 C
- 包含合约的文件是 test.sol

最后，我们将 stdout 和 stderr 记录在 parade.log 和 parade.err 中，并 fork 进程让它永远运行。
```
$ echidna-parade test.sol --config exploration.yaml --initial_time 3600 --gen_time 1800 --timeout -1 --ncores 8 --contract C > parade.log 2> parade.err &
```
运行此命令后，退出 shell，以免在连接失败时意外终止它。

## 4. 添加更多属性，检查覆盖率并在必要时修改代码
在这一步中，我们可以在 Echidna 探索合约时添加更多属性。 请记住，您应该避免更改合约的 ABI（否则语料库的质量会下降）。

此外，我们可以调整代码以提高覆盖率，但在开始之前，我们需要知道如何监控我们的fuzzing活动。 我们可以使用这个命令：
```
$ watch "grep 'COLLECTING NEW COVERAGE' parade.log | tail -n 30"
```
当找到新的覆盖范围时，您将看到如下内容：
```
COLLECTING NEW COVERAGE: parade.181140/gen.30.10/corpus/coverage/-3538310549422809236.txt
COLLECTING NEW COVERAGE: parade.181140/gen.35.9/corpus/coverage/5960152130200926175.txt
COLLECTING NEW COVERAGE: parade.181140/gen.35.10/corpus/coverage/3416698846701985227.txt
COLLECTING NEW COVERAGE: parade.181140/gen.36.6/corpus/coverage/-3997334938716772896.txt
COLLECTING NEW COVERAGE: parade.181140/gen.37.7/corpus/coverage/323061126212903141.txt
COLLECTING NEW COVERAGE: parade.181140/gen.37.6/corpus/coverage/6733481703877290093.txt
```
可以验证对应的覆盖文件，如parade.181140/gen.37.6/corpus/covered.1615497368.txt。

有关如何帮助 Echidna 提高其覆盖率的示例，请查看[提高覆盖率教程](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/collecting-a-corpus.md)。

要监视失败的属性，请使用以下命令：
```
$ watch "grep 'FAIL' parade.log | tail -n 30"
```
找到失败的属性时，您将看到如下内容：
```
NEW FAILURE: assertion in f: failed!💥
parade.181140/gen.179.0 FAILED
parade.181140/gen.179.3 FAILED
parade.181140/gen.180.2 FAILED
parade.181140/gen.180.4 FAILED
parade.181140/gen.180.3 FAILED
...
```

## 4. 结束活动
当您对覆盖结果感到满意时，您可以使用以下方法终止连续活动：
```
killall echidna-parade echidna
```