# ä½¿ç”¨ Echidna å¤§è§„æ¨¡è¿›è¡Œæ™ºèƒ½åˆçº¦ Fuzzing
åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å›é¡¾å¦‚ä½•ä½¿ç”¨ Echidna åˆ›å»ºç”¨äºfuzzingåˆçº¦çš„ä¸“ç”¨æœåŠ¡å™¨ã€‚

#### å·¥ä½œæµç¨‹ï¼š
- å®‰è£…å’Œè®¾ç½®ä¸“ç”¨æœåŠ¡å™¨
- å¼€å§‹ä¸€ä¸ªç®€çŸ­çš„fuzzingæ´»åŠ¨
- å¼€å§‹ä¸€ä¸ªè¿ç»­çš„fuzzingæ´»åŠ¨
- æ·»åŠ propertiesã€æ£€æŸ¥è¦†ç›–ç‡å¹¶åœ¨å¿…è¦æ—¶ä¿®æ”¹ä»£ç 
- ç»“æŸæ´»åŠ¨

## 1. Install and setup a dedicated server(å®‰è£…å’Œè®¾ç½®ä¸“ç”¨æœåŠ¡å™¨)
é¦–å…ˆï¼Œè·å–è‡³å°‘å…·æœ‰ 32 GB RAM å’Œå°½å¯èƒ½å¤šå†…æ ¸çš„ä¸“ç”¨æœåŠ¡å™¨ã€‚ é¦–å…ˆä¸º fuzzing æ´»åŠ¨åˆ›å»ºä¸€ä¸ªç”¨æˆ·ã€‚ ä»…ä½¿ç”¨ root å¸æˆ·åˆ›å»ºéç‰¹æƒç”¨æˆ·ï¼š
```
# adduser echidna
# usermod -aG sudo echidna
```
ç„¶åï¼Œä½¿ç”¨è¯¥ç”¨æˆ·ï¼ˆ`echidna`ï¼‰å®‰è£…ä¸€äº›åŸºæœ¬ä¾èµ–é¡¹ï¼š
```
$ sudo apt install unzip python3-pip
```
ç„¶åå®‰è£…æ„å»ºæ‚¨çš„æ™ºèƒ½åˆçº¦ä»¥åŠ`slither`å’Œ`echidna-parade`æ‰€éœ€çš„ä¸€åˆ‡ã€‚ ä¾‹å¦‚ï¼š
```
$ pip3 install solc-select
$ solc-select install all
$ pip3 install slither_analyzer
$ pip3 install echidna_parade
```
åœ¨ /home/echidna/.bashrc æœ«å°¾æ·»åŠ  $PATH=$PATH:/home/echidna/.local/bin

æ¥ä¸‹æ¥ï¼Œå®‰è£… Echidnaã€‚ æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä¸‹è½½æœ€æ–°çš„é¢„ç¼–è¯‘ Echidna ç‰ˆæœ¬ï¼Œè§£å‹ç¼©ï¼Œç„¶åå°†å…¶ç§»åŠ¨åˆ° /home/echidna/.local/binï¼š
```
$ wget "https://github.com/crytic/echidna/releases/download/v2.0.0/echidna-test-2.0.0-Ubuntu-18.04.tar.gz"
$ tar -xf echidna-test-2.0.0-Ubuntu-18.04.tar.gz
$ mv echidna-test /home/echidna/.local/bin
```
## 2. Start a short fuzzing campaign(å¼€å§‹ä¸€ä¸ªç®€çŸ­çš„æ¨¡ç³Šæµ‹è¯•æ´»åŠ¨)
é€‰æ‹©è¦æµ‹è¯•çš„åˆçº¦å¹¶åœ¨éœ€è¦æ—¶æä¾›åˆå§‹åŒ–ã€‚ å®ƒä¸å¿…æ˜¯å®Œç¾çš„ï¼Œåªéœ€ä»ä¸€äº›åŸºæœ¬çš„ä¸œè¥¿å¼€å§‹å¹¶è¿­ä»£ç»“æœå³å¯ã€‚ åœ¨å¼€å§‹æ­¤æ´»åŠ¨ä¹‹å‰ï¼Œè¯·ä¿®æ”¹æ‚¨çš„ echidna é…ç½®ä»¥å®šä¹‰è¦ä½¿ç”¨çš„corpusç›®å½•ã€‚ ä¾‹å¦‚ï¼š
```
corpusDir: "corpus-exploration"
```
è¯¥ç›®å½•å°†è‡ªåŠ¨åˆ›å»ºï¼Œä½†ç”±äºæˆ‘ä»¬æ­£åœ¨å¼€å§‹ä¸€ä¸ªæ–°çš„æ´»åŠ¨ï¼Œå¦‚æœå®ƒæ˜¯ç”±ä»¥å‰çš„echidnaæ´»åŠ¨åˆ›å»ºçš„ï¼Œè¯·åˆ é™¤è¯­æ–™åº“ç›®å½•ã€‚ å¦‚æœæ‚¨æ²¡æœ‰ä»»ä½•è¦æµ‹è¯•çš„å±æ€§ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ï¼š
```
testMode: exploration
```
å…è®¸ Echidna åœ¨æ²¡æœ‰ä»»ä½•propertiesçš„æƒ…å†µä¸‹è¿è¡Œã€‚

æˆ‘ä»¬å°†å¼€å§‹ä¸€ä¸ªéå¸¸çŸ­çš„ Echidna è¿è¡Œï¼ˆ5 åˆ†é’Ÿï¼‰ï¼Œä»¥æ£€æŸ¥ä¸€åˆ‡æ˜¯å¦æ­£å¸¸ã€‚ ä¸ºæ­¤ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹é…ç½®ï¼š
```
testLimit: 100000000000
timeout: 300 # 5 minutes
```

è¿è¡Œåï¼Œæ£€æŸ¥ä½äº `corpus-exploration/covered.*.txt` ä¸­çš„è¦†ç›–ç‡æ–‡ä»¶ã€‚ å¦‚æœåˆå§‹åŒ–é”™è¯¯ï¼Œè¯·æ¸…ç† corpus-exploration ç›®å½•å¹¶é‡æ–°å¯åŠ¨æ´»åŠ¨ã€‚

## 3. Starting a continuous fuzzing campaign(å¼€å§‹ä¸€ä¸ªè¿ç»­çš„æ¨¡ç³Šæµ‹è¯•æ´»åŠ¨)
å½“æ‚¨å¯¹åˆå§‹åŒ–çš„ç¬¬ä¸€æ¬¡è¿­ä»£æ„Ÿåˆ°æ»¡æ„æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹ä½¿ç”¨ [echidna-parade](https://github.com/agroce/echidna-parade) è¿›è¡Œæ¢ç´¢å’Œæµ‹è¯•çš„â€œæŒç»­æ´»åŠ¨â€ã€‚ åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ä»”ç»†æ£€æŸ¥æ‚¨çš„é…ç½®æ–‡ä»¶ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ·»åŠ äº†propertiesï¼Œè¯·ä¸è¦å¿˜è®°åˆ é™¤ benchmarkModeã€‚

æˆ‘ä»¬å°†ç”¨ä¸€ä¸ªä¾‹å­æ¥å±•ç¤ºå®ƒï¼Œå…¶ä¸­ï¼š

- åˆå§‹è¯­æ–™åº“ä¸ºç©º
- åŸºæœ¬é…ç½®æ–‡ä»¶å°†æ˜¯ exploration.yaml
- è¿è¡Œåˆå§‹å®ä¾‹çš„æ—¶é—´ä¸º 3600 ç§’ï¼ˆ1 å°æ—¶ï¼‰
- è¿è¡Œæ¯ä¸€â€œä»£â€çš„æ—¶é—´ä¸º 1800 ç§’ï¼ˆ30 åˆ†é’Ÿï¼‰
- æ´»åŠ¨å°†ä»¥è¿ç»­æ¨¡å¼è¿è¡Œï¼ˆå¦‚æœè¶…æ—¶ä¸º-1ï¼Œåˆ™æ„å‘³ç€æ°¸è¿œè¿è¡Œï¼‰
- æ¯ä»£ Echidna å®ä¾‹çš„æ•°é‡ä¸º 8ã€‚è¿™åº”è¯¥æ ¹æ®å¯ç”¨å†…æ ¸çš„æ•°é‡è¿›è¡Œè°ƒæ•´ï¼Œä½†å¦‚æœæ‚¨ä¸æƒ³æ€æ­»æœåŠ¡å™¨ï¼Œè¯·é¿å…ä½¿ç”¨æ‰€æœ‰å†…æ ¸
- ç›®æ ‡åˆçº¦åä¸º C
- åŒ…å«åˆçº¦çš„æ–‡ä»¶æ˜¯ test.sol

æœ€åï¼Œæˆ‘ä»¬å°† stdout å’Œ stderr è®°å½•åœ¨ parade.log å’Œ parade.err ä¸­ï¼Œå¹¶ fork è¿›ç¨‹è®©å®ƒæ°¸è¿œè¿è¡Œã€‚
```
$ echidna-parade test.sol --config exploration.yaml --initial_time 3600 --gen_time 1800 --timeout -1 --ncores 8 --contract C > parade.log 2> parade.err &
```
è¿è¡Œæ­¤å‘½ä»¤åï¼Œé€€å‡º shellï¼Œä»¥å…åœ¨è¿æ¥å¤±è´¥æ—¶æ„å¤–ç»ˆæ­¢å®ƒã€‚

## 4. æ·»åŠ æ›´å¤šå±æ€§ï¼Œæ£€æŸ¥è¦†ç›–ç‡å¹¶åœ¨å¿…è¦æ—¶ä¿®æ”¹ä»£ç 
åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Echidna æ¢ç´¢åˆçº¦æ—¶æ·»åŠ æ›´å¤šå±æ€§ã€‚ è¯·è®°ä½ï¼Œæ‚¨åº”è¯¥é¿å…æ›´æ”¹åˆçº¦çš„ ABIï¼ˆå¦åˆ™è¯­æ–™åº“çš„è´¨é‡ä¼šä¸‹é™ï¼‰ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒæ•´ä»£ç ä»¥æé«˜è¦†ç›–ç‡ï¼Œä½†åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å¦‚ä½•ç›‘æ§æˆ‘ä»¬çš„fuzzingæ´»åŠ¨ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ï¼š
```
$ watch "grep 'COLLECTING NEW COVERAGE' parade.log | tail -n 30"
```
å½“æ‰¾åˆ°æ–°çš„è¦†ç›–èŒƒå›´æ—¶ï¼Œæ‚¨å°†çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š
```
COLLECTING NEW COVERAGE: parade.181140/gen.30.10/corpus/coverage/-3538310549422809236.txt
COLLECTING NEW COVERAGE: parade.181140/gen.35.9/corpus/coverage/5960152130200926175.txt
COLLECTING NEW COVERAGE: parade.181140/gen.35.10/corpus/coverage/3416698846701985227.txt
COLLECTING NEW COVERAGE: parade.181140/gen.36.6/corpus/coverage/-3997334938716772896.txt
COLLECTING NEW COVERAGE: parade.181140/gen.37.7/corpus/coverage/323061126212903141.txt
COLLECTING NEW COVERAGE: parade.181140/gen.37.6/corpus/coverage/6733481703877290093.txt
```
å¯ä»¥éªŒè¯å¯¹åº”çš„è¦†ç›–æ–‡ä»¶ï¼Œå¦‚parade.181140/gen.37.6/corpus/covered.1615497368.txtã€‚

æœ‰å…³å¦‚ä½•å¸®åŠ© Echidna æé«˜å…¶è¦†ç›–ç‡çš„ç¤ºä¾‹ï¼Œè¯·æŸ¥çœ‹[æé«˜è¦†ç›–ç‡æ•™ç¨‹](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/collecting-a-corpus.md)ã€‚

è¦ç›‘è§†å¤±è´¥çš„å±æ€§ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```
$ watch "grep 'FAIL' parade.log | tail -n 30"
```
æ‰¾åˆ°å¤±è´¥çš„å±æ€§æ—¶ï¼Œæ‚¨å°†çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š
```
NEW FAILURE: assertion in f: failed!ğŸ’¥
parade.181140/gen.179.0 FAILED
parade.181140/gen.179.3 FAILED
parade.181140/gen.180.2 FAILED
parade.181140/gen.180.4 FAILED
parade.181140/gen.180.3 FAILED
...
```

## 4. ç»“æŸæ´»åŠ¨
å½“æ‚¨å¯¹è¦†ç›–ç»“æœæ„Ÿåˆ°æ»¡æ„æ—¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ç»ˆæ­¢è¿ç»­æ´»åŠ¨ï¼š
```
killall echidna-parade echidna
```