## ä½¿ç”¨ Echidna è¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•
å½“æ™ºèƒ½åˆçº¦éœ€è¦å¤æ‚çš„åˆå§‹åŒ–å¹¶ä¸”æ—¶é—´å¾ˆçŸ­æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›é¿å…æ‰‹åŠ¨é‡æ–°åˆ›å»ºéƒ¨ç½²ä»¥ä½¿ç”¨ Echidna è¿›è¡Œfuzzingã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬æœ‰ä¸€ç§ä½¿ç”¨ Echidna è¿›è¡Œæµ‹è¯•çš„æ–°æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åŸºäºç›´æ¥ä» ganache éƒ¨ç½²å’Œæ‰§è¡Œæµ‹è¯•ã€‚

## è¦æ±‚ï¼š
è¿™ç§æ–¹æ³•éœ€è¦ä¸€ä¸ªæ™ºèƒ½åˆçº¦é¡¹ç›®ï¼Œå…·æœ‰ä»¥ä¸‹çº¦æŸï¼š

- å®ƒåº”è¯¥ä½¿ç”¨ Solidityï¼šä¸æ”¯æŒ Vyperï¼Œå› ä¸º Slither/Echidna åœ¨è¿è¡Œè¿™äº›æ–¹é¢ä¸æ˜¯å¾ˆæœ‰æ•ˆï¼ˆä¾‹å¦‚ï¼Œä¸åŒ…æ‹¬ ASTï¼‰ã€‚
- å®ƒåº”è¯¥æœ‰æµ‹è¯•ï¼Œæˆ–è€…è‡³å°‘æœ‰ä¸€ä¸ªå®Œæ•´çš„éƒ¨ç½²è„šæœ¬ã€‚
- å®ƒåº”è¯¥ä¸ Slither ä¸€èµ·ä½¿ç”¨ã€‚ å¦‚æœå¤±è´¥ï¼Œè¯·æŠ¥å‘Šé—®é¢˜ã€‚
åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†[drizzle-box example](https://github.com/truffle-box/drizzle-box)ã€‚

## å…¥é—¨ï¼š
åœ¨è¯´æ˜ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨å·²å®‰è£… Echidna å’Œ Etheno çš„æœ€æ–°ç‰ˆæœ¬ã€‚

ç„¶åï¼Œå®‰è£…åŒ…æ¥ç¼–è¯‘é¡¹ç›®ï¼š
```
$ git clone https://github.com/truffle-box/drizzle-box
$ cd drizzle-box
$ npm i truffle
```

å¦‚æœæœªå®‰è£… ganacheï¼Œè¯·æ‰‹åŠ¨æ·»åŠ ã€‚ åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†è¿è¡Œï¼š
```
$ npm i ganache
```
å…¶ä»–ä½¿ç”¨ yarn çš„é¡¹ç›®éœ€è¦ï¼š
```
yarn add ganache
```
ç¡®ä¿ `$ ganache --version` è¾“å‡º ganache `v7.3.2` æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚

ä»å¯ç”¨æµ‹è¯•ä¸­é€‰æ‹©ä¸€ä¸ªæµ‹è¯•è„šæœ¬ä¹Ÿå¾ˆé‡è¦ã€‚ ç†æƒ³æƒ…å†µä¸‹ï¼Œè¯¥æµ‹è¯•å°†éƒ¨ç½²æ‰€æœ‰ï¼ˆæˆ–å¤§å¤šæ•°ï¼‰åˆçº¦ï¼ŒåŒ…æ‹¬æ¨¡æ‹Ÿ/æµ‹è¯•åˆçº¦ã€‚ å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å°†çœ‹ä¸€ä¸‹ SimpleStorage åˆçº¦ï¼š
```
contract SimpleStorage {
    event StorageSet(string _message);

    uint256 public storedData;

    function set(uint256 x) public {
        storedData = x;

        emit StorageSet("Data stored successfully!");
    }
}
```
è¿™ä¸ªå°åˆçº¦å…è®¸è®¾ç½® storedData çŠ¶æ€å˜é‡ã€‚ æ­£å¦‚é¢„æœŸçš„é‚£æ ·ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå•å…ƒæµ‹è¯•æ¥éƒ¨ç½²å’Œæµ‹è¯•è¿™ä¸ªåˆçº¦ï¼ˆsimplestorage.jsï¼‰ï¼š
```
const SimpleStorage = artifacts.require("SimpleStorage");

contract("SimpleStorage", accounts => {
  it("...should store the value 89.", async () => {
    const simpleStorageInstance = await SimpleStorage.deployed();

    // Set value of 89
    await simpleStorageInstance.set(89, { from: accounts[0] });

    // Get stored value
    const storedData = await simpleStorageInstance.storedData.call();

    assert.equal(storedData, 89, "The value 89 was not stored.");
  });
});
```
## æ•è·äº¤æ˜“
åœ¨å¼€å§‹ç¼–å†™æœ‰è¶£çš„å±æ€§ä¹‹å‰ï¼Œæœ‰å¿…è¦æ”¶é›†ä¸€ä¸ª Etheno è·Ÿè¸ªä»¥åœ¨ Echidna ä¸­é‡æ”¾å®ƒï¼š

é¦–å…ˆï¼Œå¯åŠ¨ Ethenoï¼š
```
etheno --ganache --ganache-args="--miner.blockGasLimit 10000000" -x init.json
```
é»˜è®¤æƒ…å†µä¸‹ï¼Œä»¥ä¸‹ Ganache å‚æ•°æ˜¯é€šè¿‡ Etheno è®¾ç½®çš„ï¼š

- `-d`ï¼šGanache å°†ä½¿ç”¨é¢„å®šä¹‰çš„ç¡®å®šæ€§ç§å­æ¥åˆ›å»ºæ‰€æœ‰å¸æˆ·ã€‚
- `--chain.allowUnlimitedContractSize`ï¼šåœ¨è°ƒè¯•æ—¶å…è®¸æ— é™çš„åˆçº¦å¤§å°ã€‚ è¿™æ ·è®¾ç½®æ˜¯ä¸ºäº†å¯¹è¦éƒ¨ç½²çš„åˆçº¦æ²¡æœ‰å¤§å°é™åˆ¶
- `-p <port_num>`ï¼š`port_num` å°†è®¾ç½®ä¸º 
    (1) --ganache-port çš„å€¼æˆ– 
    (2) Etheno å°†é€‰æ‹©æ¯”è¿è¡Œ Etheno çš„ JSON RPC æœåŠ¡å™¨çš„ç«¯å£å·é«˜çš„æœ€å°ç«¯å£å·ã€‚

æ³¨æ„ï¼šå¦‚æœä½ ä½¿ç”¨ Docker è¿è¡Œ ethenoï¼Œå‘½ä»¤åº”è¯¥æ˜¯ï¼š
```
$ docker run -it -p 8545:8545 -v ~/etheno:/home/etheno/ trailofbits/etheno
(you will now be working within the Docker instance)
$ etheno --ganache --ganache-args="--miner.blockGasLimit 10000000" -x init.json
```

- ç¬¬ä¸€ä¸ªå‘½ä»¤ä¸­çš„ `-p` å°† Docker å®¹å™¨å†…éƒ¨çš„ç«¯å£ 8545 å‘å¸ƒï¼ˆå³å…¬å¼€ï¼‰åˆ°ä¸»æœºä¸Šçš„ç«¯å£ 8545ã€‚
- ç¬¬ä¸€ä¸ªå‘½ä»¤ä¸­çš„ `-v` å°† Docker å®¹å™¨å†…éƒ¨çš„ç›®å½•æ˜ å°„åˆ° Docker å®¹å™¨å¤–éƒ¨çš„ç›®å½•ã€‚ Etheno é€€å‡ºåï¼Œ`init.json` æ–‡ä»¶ç°åœ¨å°†ä½äºä¸»æœºä¸Šçš„ `~/etheno` æ–‡ä»¶å¤¹ä¸­ã€‚

è¯·æ³¨æ„ï¼Œå¦‚æœéƒ¨ç½²ç”±äº`ProviderError: exceeds block gas limit`å¼‚å¸¸è€Œæ— æ³•æˆåŠŸå®Œæˆï¼Œå¢åŠ  `--miner.blockGasLimit` å€¼ä¼šæœ‰æ‰€å¸®åŠ©ã€‚ è¿™å¯¹äºå¤§å‹åˆçº¦éƒ¨ç½²ç‰¹åˆ«æœ‰ç”¨ã€‚ å•å‡»[æ­¤å¤„](https://www.npmjs.com/package/ganache)äº†è§£æœ‰å…³å¯ä»¥è®¾ç½®çš„å„ç§ Ganache å‘½ä»¤è¡Œå‚æ•°çš„æ›´å¤šä¿¡æ¯ã€‚

æ­¤å¤–ï¼Œå¦‚æœ Etheno æœªèƒ½äº§ç”Ÿä»»ä½•è¾“å‡ºï¼Œåˆ™å®ƒæ— æ³•åœ¨åå°æ‰§è¡Œ `ganache`ã€‚ æ£€æŸ¥æ˜¯å¦å¯ä»¥åœ¨ä¸ä½¿ç”¨ Etheno çš„æƒ…å†µä¸‹ä»ç»ˆç«¯æ­£ç¡®æ‰§è¡Œ `ganache`ï¼ˆå¸¦æœ‰ç›¸å…³çš„å‘½ä»¤è¡Œå‚æ•°ï¼‰ã€‚

åŒæ—¶ï¼Œåœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­ï¼Œè¿è¡Œä¸€ä¸ªæµ‹è¯•æˆ–éƒ¨ç½²è¿‡ç¨‹ã€‚ å¦‚ä½•è¿è¡Œå®ƒå–å†³äºé¡¹ç›®æ˜¯å¦‚ä½•å¼€å‘çš„ã€‚ ä¾‹å¦‚ï¼Œå¯¹äºtruffleï¼Œä½¿ç”¨ï¼š
```
$ truffle test test/test.js
```
å¯¹äºå»ºè®¾è€…:
```
buidler test test/test.js --network localhost
```
åœ¨ Drizzle ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†è¿è¡Œï¼š
```
truffle test test/simplestorage.js --network develop
```
Etheno å®Œæˆåï¼Œä½¿ç”¨ Ctrl+cï¼ˆæˆ– Mac ä¸Šçš„ Command+Cï¼‰è½»è½»åœ°æ€æ­»å®ƒã€‚ å®ƒå°†ä¿å­˜ `init.json` æ–‡ä»¶ã€‚ å¦‚æœæ‚¨çš„æµ‹è¯•ç”±äºæŸç§åŸå› å¤±è´¥æˆ–è€…æ‚¨æƒ³è¿è¡Œå¦ä¸€ä¸ªæµ‹è¯•ï¼Œè¯·é‡æ–°å¯åŠ¨ Etheno å¹¶é‡æ–°è¿è¡Œæµ‹è¯•ã€‚

## ç¼–å†™å’Œè¿è¡Œå±æ€§
ä¸€æ—¦æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªä¿å­˜äº¤æ˜“çš„ json æ–‡ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥éªŒè¯ `SimpleStorage` åˆçº¦éƒ¨ç½²åœ¨ `0x871DD7C2B4b25E1Aa18728e9D5f2Af4C4e431f5c`ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°ç¼–å†™ä¸€ä¸ªå¸¦æœ‰ç®€å•å±æ€§çš„åˆçº¦ï¼ˆ`./contracts/crytic/E2E.sol`ï¼‰æ¥æµ‹è¯•å®ƒï¼š
```
import "../SimpleStorage.sol";

contract E2E {
        SimpleStorage st = SimpleStorage(0x871DD7C2B4b25E1Aa18728e9D5f2Af4C4e431f5c);
        function crytic_const_storage() public returns(bool) {
            return st.storedData() == 89;
        }
}
```

è¿™ä¸ªç®€å•çš„å±æ€§æ£€æŸ¥å­˜å‚¨çš„æ•°æ®æ˜¯å¦ä¿æŒä¸å˜ã€‚ è¦è¿è¡Œå®ƒï¼Œæ‚¨å°†éœ€è¦ä»¥ä¸‹é’ˆé¼¹é…ç½®æ–‡ä»¶ (`echidna.yaml`)ï¼š
```
prefix: crytic_
initialize: init.json
multi-abi: true
cryticArgs: ['--truffle-build-directory', 'app/src/contracts/'] # needed by drizzle
```
ç„¶åï¼Œè¿è¡Œ Echidna ç«‹å³æ˜¾ç¤ºç»“æœï¼š
```
$ echidna-test . --contract E2E --config echidna.yaml
...
crytic_const_storage: failed!ğŸ’¥  
  Call sequence:
    (0x871dd7c2b4b25e1aa18728e9d5f2af4c4e431f5c).set(0) from: 0x0000000000000000000000000000000000010000
```
å¯¹äºè¿™æœ€åä¸€æ­¥ï¼Œè¯·ç¡®ä¿æ‚¨ä½¿ç”¨çš„æ˜¯ `.` ä½œä¸º`echidna-test`çš„ç›®æ ‡ã€‚ å¦‚æœæ‚¨æ”¹ç”¨ `E2E.sol` æ–‡ä»¶çš„è·¯å¾„ï¼Œé‚£ä¹ˆ Echidna å°†æ— æ³•ä»æ‰€æœ‰å·²éƒ¨ç½²çš„åˆçº¦ä¸­è·å–ä¿¡æ¯æ¥è°ƒç”¨ `set(uint256)` å‡½æ•°ï¼Œå¹¶ä¸”è¯¥å±æ€§å°†æ°¸è¿œä¸ä¼šå¤±è´¥ã€‚

## ä¸»è¦è€ƒè™‘å› ç´ ï¼š
å°† Etheno ä¸ Echidna ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œè¯·æ³¨æ„æœ‰ä¸¤ç§æç«¯æƒ…å†µå¯èƒ½ä¼šå¯¼è‡´æ„å¤–è¡Œä¸ºï¼š

- ä½¿ç”¨ ether çš„å‡½æ•°è°ƒç”¨ï¼šåœ¨ Ganache ä¸­åˆ›å»ºå’Œç”¨äºæµ‹è¯•çš„å¸æˆ·ä¸åœ¨ Echidna ä¸­ç”¨äºå‘é€äº¤æ˜“çš„å¸æˆ·ä¸åŒã€‚ å› æ­¤ï¼ŒGanache è´¦æˆ·çš„è´¦æˆ·ä½™é¢ä¸ä¼šç»“è½¬åˆ° Echidna ä½¿ç”¨çš„è´¦æˆ·ã€‚ å› æ­¤ï¼Œå¦‚æœ Etheno è®°å½•çš„å‡½æ•°è°ƒç”¨éœ€è¦ä» Ganache ä¸­å­˜åœ¨çš„å¸æˆ·è½¬ç§»ä¸€äº›ä»¥å¤ªå¸ï¼Œåˆ™æ­¤è°ƒç”¨å°†åœ¨ Echidna ä¸­å¤±è´¥ã€‚
- ä¾èµ– block.timestamp çš„Fuzzï¼šGanache å’Œ Echidna çš„æ—¶é—´æ¦‚å¿µä¸åŒã€‚ Echidna æ€»æ˜¯ä»¥å›ºå®šçš„æ—¶é—´æˆ³å¼€å§‹ï¼Œè€Œ Etheno å°†ä½¿ç”¨ Ganache çš„æ—¶é—´æ¦‚å¿µã€‚ è¿™æ„å‘³ç€ä¾èµ–æ—¶é—´æˆ³æ¯”è¾ƒ/è¯„ä¼°çš„fuzzæµ‹è¯•ä¸­çš„æ–­è¨€æˆ–è¦æ±‚å¯èƒ½ä¼šåœ¨ Echidna ä¸­å¤±è´¥ã€‚
  
åœ¨æœ¬æ•™ç¨‹çš„ä¸‹ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢å¦‚ä½•ä½¿ç”¨åŸºäº Slither çš„ç‰¹å®šå·¥å…·è½»æ¾æ‰¾åˆ°åˆçº¦çš„éƒ¨ç½²ä½ç½®ã€‚ å¦‚æœéƒ¨ç½²è¿‡ç¨‹å¾ˆå¤æ‚å¹¶ä¸”æˆ‘ä»¬éœ€è¦æµ‹è¯•ç‰¹å®šçš„åˆçº¦ï¼Œè¿™å°†å¾ˆæœ‰ç”¨ã€‚