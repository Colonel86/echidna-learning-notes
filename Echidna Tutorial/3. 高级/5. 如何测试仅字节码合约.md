## ä»‹ç»
æˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•åœ¨æ²¡æœ‰æä¾›ä»»ä½•æºä»£ç çš„æƒ…å†µä¸‹å¯¹åˆçº¦è¿›è¡Œfuzzingã€‚ è¯¥æŠ€æœ¯è¿˜å¯ç”¨äºåœ¨ Solidity åˆçº¦å’Œ Vyper åˆçº¦ä¹‹é—´æ‰§è¡Œå·®åˆ†fuzzingï¼ˆå³æ¯”è¾ƒå¤šä¸ªå®ç°ï¼‰ã€‚

è€ƒè™‘ä»¥ä¸‹å­—èŠ‚ç ï¼š
```
608060405234801561001057600080fd5b506103e86000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506103e86001819055506101fa8061006e6000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c806318160ddd1461004657806370a0823114610064578063a9059cbb146100bc575b600080fd5b61004e61010a565b6040518082815260200191505060405180910390f35b6100a66004803603602081101561007a57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610110565b6040518082815260200191505060405180910390f35b610108600480360360408110156100d257600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050610128565b005b60015481565b60006020528060005260406000206000915090505481565b806000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282540392505081905550806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282540192505081905550505056fe
```
æˆ‘ä»¬åªçŸ¥é“ä»¥ä¸‹ABIï¼š
```
interface Target{
  function totalSupply() external returns(uint);
  function balanceOf(address) external returns(uint);
  function transfer(address, uint) external;
}
```
æˆ‘ä»¬æƒ³æµ‹è¯•æ˜¯å¦æœ‰å¯èƒ½æ‹¥æœ‰æ¯”æ€»ä¾›åº”æ›´å¤šçš„ä»£å¸ã€‚

## ä»£ç†æ¨¡å¼
å› ä¸ºæˆ‘ä»¬æ²¡æœ‰æºä»£ç ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥åœ¨åˆçº¦ä¸­æ·»åŠ propertyã€‚ ç›¸åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä»£ç†åˆçº¦ï¼š
```
interface Target{
  function totalSupply() external returns(uint);
  function balanceOf(address) external returns(uint);
  function transfer(address, uint) external;
}

contract TestBytecodeOnly{
    Target t;

    constructor() public{
        address target_addr;
        // init bytecode
        bytes memory target_bytecode = hex"608060405234801561001057600080fd5b506103e86000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506103e86001819055506101fa8061006e6000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c806318160ddd1461004657806370a0823114610064578063a9059cbb146100bc575b600080fd5b61004e61010a565b6040518082815260200191505060405180910390f35b6100a66004803603602081101561007a57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610110565b6040518082815260200191505060405180910390f35b610108600480360360408110156100d257600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050610128565b005b60015481565b60006020528060005260406000206000915090505481565b806000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282540392505081905550806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282540192505081905550505056fe";

        uint size = target_bytecode.length;

        assembly{
            target_addr := create(0, 0xa0, size) // 0xa0 was manually computed. It might require different value according to the compiler version
        }
        t = Target(target_addr);
    }

    function transfer(address to, uint amount) public {
        t.transfer(to, amount);
    }

    function echidna_test_balance() public returns(bool){
        return t.balanceOf(address(this)) <= t.totalSupply();
    }
}
```
ä»£ç†ï¼š
- åœ¨å…¶æ„é€ å‡½æ•°ä¸­éƒ¨ç½²å­—èŠ‚ç 
- æœ‰ä¸€ä¸ªå‡½æ•°ä¼šè°ƒç”¨ç›®æ ‡çš„`transfer`å‡½æ•°
- æœ‰ä¸€ä¸ª Echidna å±æ€§ `t.balanceOf(address(this)) <= t.totalSupply()`

## Run Echidna
```
$ echidna-test bytecode_only.sol --contract TestBytecodeOnly
echidna_test_balance: failed!ğŸ’¥  
  Call sequence:
    transfer(0x0,1002)
```
åœ¨è¿™é‡Œï¼ŒEchidna å‘ç°é€šè¿‡è°ƒç”¨ transfer(0, 1002) ä»»ä½•äººéƒ½å¯ä»¥é“¸é€ ä»£å¸ã€‚
## ç›®æ ‡æºä»£ç 
ç›®æ ‡çš„å®é™…æºä»£ç æ˜¯ï¼š
```
contract C{
    mapping(address => uint) public balanceOf;
    uint public totalSupply;

    constructor() public{
        balanceOf[msg.sender] = 1000;
        totalSupply = 1000;
    }

    function transfer(address to, uint amount) public{
        balanceOf[msg.sender] -= amount;
        balanceOf[to] += amount;
    }
}
```
Echidna æ­£ç¡®åœ°å‘ç°äº†é”™è¯¯ï¼šä¼ è¾“ä¸­ç¼ºå°‘æº¢å‡ºæ£€æŸ¥ã€‚

## å·®åˆ†æ¨¡ç³Š
è€ƒè™‘ä»¥ä¸‹ Vyper å’Œ Solidity åˆçº¦ï¼š
```
@view
@external
def my_func(a: uint256, b: uint256, c: uint256) -> uint256:
    return a * b / c
```
```
contract SolidityVersion{
    function my_func(uint a, uint b, uint c) view public{
        return a * b / c;
    }
}
```
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»£ç†æ¨¡å¼æµ‹è¯•å®ƒä»¬æ˜¯å¦æ€»æ˜¯è¿”å›ç›¸åŒçš„å€¼ï¼š
```
interface Target{
  function my_func(uint, uint, uint) external returns(uint);
}

contract SolidityVersion{
    Target t;

    constructor() public{
        address target_addr;

        // vyper bytecode
        bytes memory target_bytecode = hex"61007756341561000a57600080fd5b60043610156100185761006d565b600035601c52630ff198a3600051141561006c57600435602435808202821582848304141761004657600080fd5b80905090509050604435808061005b57600080fd5b82049050905060005260206000f350005b5b60006000fd5b61000461007703610004600039610004610077036000f3";

        uint size = target_bytecode.length;

        assembly{
            target_addr := create(0, 0xa0, size) // 0xa0 was manually computed. It might require different value according to the compiler version
        }
        t = Target(target_addr);
    }

    function test(uint a, uint b, uint c) public returns(bool){
        assert(my_func(a, b, c) == t.my_func(a, b, c));
    }

    function my_func(uint a, uint b, uint c) view internal returns(uint){
        return a * b / c;
    }
}
```
åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨assertion modeè¿è¡Œ Echidnaï¼š
```
$ echidna-test  vyper.sol --config config.yaml --contract SolidityVersion --test-mode assertion
assertion in test: passed! ğŸ‰
```
## é€šç”¨ä»£ç†ä»£ç 
æ ¹æ®æ‚¨çš„éœ€è¦è°ƒæ•´ä»¥ä¸‹ä»£ç ï¼š
```
interface Target{
  // public/external functions
}

contract TestBytecodeOnly{
    Target t;

    constructor() public{
        address target_addr;
        // init bytecode
        bytes memory target_bytecode = hex"";

        uint size = target_bytecode.length;

        assembly{
            target_addr := create(0, 0xa0, size) // 0xa0 was manually computed. It might require different value according to the compiler version
        }
        t = Target(target_addr);
    }

    // Add helper functions to call the target's functions from the proxy

    function echidna_test() public returns(bool){
      // The property to test
    }
}
```
## æ‘˜è¦ï¼šæ— éœ€æºä»£ç å³å¯æµ‹è¯•åˆçº¦
Echidna å¯ä»¥ä½¿ç”¨ä»£ç†åˆçº¦åœ¨æ²¡æœ‰æºä»£ç çš„æƒ…å†µä¸‹å¯¹åˆçº¦è¿›è¡Œæ¨¡ç³Šæµ‹è¯•ã€‚ è¿™ç§æŠ€æœ¯ä¹Ÿå¯ä»¥ç”¨æ¥æ¯”è¾ƒç”¨ Solidity å’Œ Vyper ç¼–å†™çš„å®ç°ã€‚